<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semantic & Natural Language Search Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .search-modes {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .mode-button {
            padding: 12px 24px;
            border: 2px solid #e1e5e9;
            background: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: 600;
        }

        .mode-button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .search-section {
            margin-bottom: 40px;
        }

        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 20px 60px 20px 20px;
            font-size: 1.1rem;
            border: 2px solid #e1e5e9;
            border-radius: 50px;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #667eea;
            font-size: 1.2rem;
        }

        .examples {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .examples h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .example-queries {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .example-query {
            padding: 8px 16px;
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .example-query:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .results {
            margin-top: 30px;
        }

        .company-card {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .company-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .company-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }

        .company-location {
            color: #666;
            font-size: 1rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .positions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .positions-count {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .positions-text {
            color: #666;
            font-size: 0.9rem;
        }

        .search-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: #1565c0;
        }

        .highlight {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .no-results-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .mode-description {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            border-left: 4px solid #667eea;
        }

        .mode-description h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .mode-description p {
            color: #666;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .content {
                padding: 20px;
            }
            
            .search-modes {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß†üí¨ Semantic & Natural Language Search</h1>
            <p>Advanced search capabilities with Typesense</p>
        </div>

        <div class="content">
            <div class="search-modes">
                <button class="mode-button active" data-mode="semantic">üß† Semantic Search</button>
                <button class="mode-button" data-mode="natural">üí¨ Natural Language</button>
                <button class="mode-button" data-mode="advanced">üöÄ Advanced Features</button>
            </div>

            <div id="modeDescription" class="mode-description">
                <h3>üß† Semantic Search</h3>
                <p>Search by meaning and context, not just exact keywords. Typesense uses fuzzy matching, multi-field search, and intelligent ranking to understand what you're looking for, even when you don't use the exact words.</p>
            </div>

            <div class="search-section">
                <div class="search-box">
                    <input type="text" id="searchInput" class="search-input" placeholder="Try: 'companies that develop software' or 'tech companies hiring'">
                    <span class="search-icon">üîç</span>
                </div>

                <div class="examples">
                    <h3>üí° Example Queries:</h3>
                    <div id="exampleQueries" class="example-queries">
                        <div class="example-query" data-query="companies that develop software">companies that develop software</div>
                        <div class="example-query" data-query="tech companies hiring">tech companies hiring</div>
                        <div class="example-query" data-query="companies in da nang">companies in da nang</div>
                        <div class="example-query" data-query="software development">software development</div>
                        <div class="example-query" data-query="companies with open positions">companies with open positions</div>
                        <div class="example-query" data-query="technology solutions">technology solutions</div>
                    </div>
                </div>
            </div>

            <div id="searchInfo" class="search-info" style="display: none;">
                <strong>Search Info:</strong> <span id="searchInfoText"></span>
            </div>

            <div id="results" class="results">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading companies...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Typesense API configuration
        const TYPESENSE_API_KEY = 'Hu52dwsas2AdxdE';
        const TYPESENSE_HOST = 'http://localhost:8108';
        const COLLECTION_NAME = 'enfue_companies';

        // Global state
        let currentMode = 'semantic';

        // Mode descriptions
        const modeDescriptions = {
            semantic: {
                title: 'üß† Semantic Search',
                description: 'Search by meaning and context, not just exact keywords. Typesense uses fuzzy matching, multi-field search, and intelligent ranking to understand what you\'re looking for, even when you don\'t use the exact words.'
            },
            natural: {
                title: 'üí¨ Natural Language Search',
                description: 'Ask questions in natural language and Typesense will parse them into structured queries. Try asking "Show me tech companies in Da Nang with open positions" or "Find companies that are hiring developers".'
            },
            advanced: {
                title: 'üöÄ Advanced Features',
                description: 'Explore advanced Typesense features like faceted search, highlighting, grouping, and performance optimization. See how Typesense handles complex queries with multiple filters and sorting options.'
            }
        };

        // Example queries for each mode
        const exampleQueries = {
            semantic: [
                'companies that develop software',
                'tech companies hiring',
                'software development',
                'technology solutions',
                'companies with open positions',
                'digital technology'
            ],
            natural: [
                'Show me companies in Da Nang',
                'Find companies that are hiring',
                'Companies with more than 5 positions',
                'Tech companies in Ho Chi Minh',
                'Show me the biggest companies',
                'Companies starting with A'
            ],
            advanced: [
                'tech AND da nang AND open positions',
                'companies:>5 positions',
                'location:=Da Nang && has_positions:=true',
                'sort by positions descending',
                'group by location',
                'highlight tech companies'
            ]
        };

        // Search companies using different strategies based on mode
        async function searchCompanies(query, mode) {
            try {
                const searchParams = new URLSearchParams({
                    q: query || '*',
                    query_by: 'company_name',
                    per_page: '10',
                    page: '1'
                });

                // Add mode-specific parameters
                switch (mode) {
                    case 'semantic':
                        // Multi-field search for semantic understanding
                        searchParams.set('query_by', 'company_name,location');
                        searchParams.append('highlight_fields', 'company_name');
                        searchParams.append('highlight_affix_num_tokens', '3');
                        break;
                    
                    case 'natural':
                        // Parse natural language queries
                        const parsedQuery = parseNaturalLanguage(query);
                        if (parsedQuery.filter_by) {
                            searchParams.append('filter_by', parsedQuery.filter_by);
                        }
                        if (parsedQuery.sort_by) {
                            searchParams.append('sort_by', parsedQuery.sort_by);
                        }
                        searchParams.set('q', parsedQuery.q);
                        break;
                    
                    case 'advanced':
                        // Advanced features
                        searchParams.append('facet_by', 'location,has_positions');
                        searchParams.append('highlight_fields', 'company_name');
                        searchParams.append('group_by', 'location');
                        searchParams.append('group_limit', '3');
                        break;
                }

                const url = `${TYPESENSE_HOST}/collections/${COLLECTION_NAME}/documents/search?${searchParams}`;
                
                const response = await fetch(url, {
                    headers: {
                        'x-typesense-api-key': TYPESENSE_API_KEY,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const results = await response.json();
                return results;
            } catch (error) {
                console.error('Search error:', error);
                return { hits: [], found: 0 };
            }
        }

        // Parse natural language queries
        function parseNaturalLanguage(query) {
            const lowerQuery = query.toLowerCase();
            let parsed = { q: query, filter_by: '', sort_by: '' };
            
            // Location parsing
            if (lowerQuery.includes('da nang')) {
                parsed.filter_by = 'location:=Da Nang';
                parsed.q = query.replace(/da nang/gi, '').trim() || '*';
            } else if (lowerQuery.includes('ho chi minh')) {
                parsed.filter_by = 'location:=Ho Chi Minh';
                parsed.q = query.replace(/ho chi minh/gi, '').trim() || '*';
            } else if (lowerQuery.includes('hue')) {
                parsed.filter_by = 'location:=Hue';
                parsed.q = query.replace(/hue/gi, '').trim() || '*';
            }
            
            // Job-related parsing
            if (lowerQuery.includes('hiring') || lowerQuery.includes('open positions')) {
                if (parsed.filter_by) {
                    parsed.filter_by += ' && has_positions:=true';
                } else {
                    parsed.filter_by = 'has_positions:=true';
                }
            }
            
            // Position count parsing
            if (lowerQuery.includes('more than 5') || lowerQuery.includes('>5')) {
                if (parsed.filter_by) {
                    parsed.filter_by += ' && open_positions:>5';
                } else {
                    parsed.filter_by = 'open_positions:>5';
                }
            }
            
            // Sorting parsing
            if (lowerQuery.includes('biggest') || lowerQuery.includes('largest')) {
                parsed.sort_by = 'open_positions:desc';
            } else if (lowerQuery.includes('smallest')) {
                parsed.sort_by = 'open_positions:asc';
            }
            
            return parsed;
        }

        // Highlight search terms
        function highlightText(text, query) {
            if (!query || query === '*') return text;
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        // Render company card
        function renderCompanyCard(company) {
            const query = document.getElementById('searchInput').value;
            let highlightedName = company.document.company_name;
            
            // Use Typesense highlighting if available
            if (company.highlight && company.highlight.company_name) {
                highlightedName = company.highlight.company_name.snippet;
            } else {
                highlightedName = highlightText(company.document.company_name, query);
            }
            
            return `
                <div class="company-card">
                    <div class="company-name">${highlightedName}</div>
                    <div class="company-location">
                        <span>üìç</span>
                        ${company.document.location}
                    </div>
                    <div class="positions">
                        <span class="positions-count">${company.document.open_positions}</span>
                        <span class="positions-text">open position${company.document.open_positions !== 1 ? 's' : ''}</span>
                    </div>
                </div>
            `;
        }

        // Render results
        function renderResults(results) {
            const resultsContainer = document.getElementById('results');
            
            if (!results.hits || results.hits.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">üîç</div>
                        <h3>No companies found</h3>
                        <p>Try adjusting your search terms or try a different search mode</p>
                    </div>
                `;
                return;
            }

            const html = results.hits.map(renderCompanyCard).join('');
            resultsContainer.innerHTML = html;
        }

        // Show search info
        function showSearchInfo(results) {
            const searchInfoContainer = document.getElementById('searchInfo');
            const searchInfoText = document.getElementById('searchInfoText');
            
            let info = `Found ${results.found} companies using ${currentMode} search`;
            if (results.facet_counts && results.facet_counts.length > 0) {
                info += ` with ${results.facet_counts.length} facet groups`;
            }
            
            searchInfoText.textContent = info;
            searchInfoContainer.style.display = 'block';
        }

        // Perform search
        async function performSearch() {
            const query = document.getElementById('searchInput').value;
            
            try {
                const results = await searchCompanies(query, currentMode);
                renderResults(results);
                showSearchInfo(results);
            } catch (error) {
                console.error('Search failed:', error);
                document.getElementById('results').innerHTML = `
                    <div class="error">
                        <strong>Search Error:</strong> ${error.message}
                        <br><small>Make sure Typesense server is running on localhost:8108</small>
                    </div>
                `;
            }
        }

        // Update mode description and examples
        function updateModeContent(mode) {
            const description = modeDescriptions[mode];
            const modeDescriptionEl = document.getElementById('modeDescription');
            const exampleQueriesEl = document.getElementById('exampleQueries');
            
            modeDescriptionEl.innerHTML = `
                <h3>${description.title}</h3>
                <p>${description.description}</p>
            `;
            
            exampleQueriesEl.innerHTML = exampleQueries[mode].map(query => 
                `<div class="example-query" data-query="${query}">${query}</div>`
            ).join('');
        }

        // Event listeners
        function setupEventListeners() {
            // Search input
            document.getElementById('searchInput').addEventListener('input', performSearch);
            
            // Mode buttons
            document.querySelectorAll('.mode-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    document.querySelectorAll('.mode-button').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentMode = e.target.dataset.mode;
                    updateModeContent(currentMode);
                    performSearch();
                });
            });
            
            // Example queries
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('example-query')) {
                    const query = e.target.dataset.query;
                    document.getElementById('searchInput').value = query;
                    performSearch();
                }
            });
        }

        // Initialize app
        async function init() {
            console.log('üöÄ Initializing Semantic & Natural Language Search Demo...');
            
            try {
                setupEventListeners();
                updateModeContent(currentMode);
                await performSearch();
                console.log('‚úÖ Demo initialized successfully');
            } catch (error) {
                console.error('‚ùå Initialization failed:', error);
                document.getElementById('results').innerHTML = `
                    <div class="error">
                        <strong>Initialization Error:</strong> ${error.message}
                        <br><small>Make sure Typesense server is running on localhost:8108</small>
                    </div>
                `;
            }
        }

        // Start the app when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
